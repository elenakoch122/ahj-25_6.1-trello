(()=>{"use strict";const e={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let t;const s=new Uint8Array(16),n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));const r=function(r,o,i){if(e.randomUUID&&!o&&!r)return e.randomUUID();const a=(r=r||{}).random??r.rng?.()??function(){if(!t){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");t=crypto.getRandomValues.bind(crypto)}return t(s)}();if(a.length<16)throw new Error("Random bytes length must be >= 16");if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,o){if((i=i||0)<0||i+16>o.length)throw new RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`);for(let e=0;e<16;++e)o[i+e]=a[e];return o}return function(e,t=0){return(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase()}(a)};class o{constructor(e,t,s){this.text=e,this.column=t,this.id=s}create(){const e=document.createElement("div");e.classList.add("column__card"),e.setAttribute("data-id",this.id),e.textContent=this.text;const t=document.createElement("span");return t.classList.add("close","column__card-close"),e.append(t),e}}class i{constructor(e){this.elem=this.createGhost(e)}createGhost(e){const t=document.createElement("div");return t.classList.add("ghost"),t.style.width=`${e.offsetWidth}px`,t.style.height=`${e.offsetHeight}px`,t}delete(){this.elem.remove()}}class a{constructor(e,t,s){this.elem=e,this.shiftX=t,this.shiftY=s,this.ghost=new i(e),this.card=null,this.index=null}bindToDOM(){this.elem.parentElement.insertBefore(this.ghost.elem,this.elem),this.elem.classList.add("dragged"),this.shiftX-=this.elem.offsetLeft,this.shiftY-=this.elem.offsetTop-this.elem.offsetHeight-7,this.elem.style.left="0px",this.elem.style.top=this.elem.offsetTop-this.elem.offsetHeight-7+"px"}move(e,t){this.elem.style.left=e-this.shiftX+"px",this.elem.style.top=t-this.shiftY+"px"}clear(){this.elem.removeAttribute("style"),this.elem.classList.remove("dragged")}}class l{constructor(){this.cards=[]}}class d{constructor(e){this.element=document.querySelector(".board"),this.stateService=e,this.state=new l,this.dragEl=null,this.underDrag=null,this.isColumn=null,this.isColumnCardUnderDrag=null,this.isColumnFooterElemUnderDrag=null,this.isColumnFooterUnderDrag=null,this.onClickCardDelete=this.onClickCardDelete.bind(this),this.onClickFooter=this.onClickFooter.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this)}static get markupSaveBtn(){return'\n    <textarea class="column__add-textarea" cols="30" rows="4" placeholder="Напишите задачу..."></textarea>\n    <button class="column__save">Добавить</button>\n    <span class="close column__add-close"></span>\n    '}static get markupAddBtn(){return'\n    <button class="column__add">Добавить задачу</button>\n    '}init(){const e=this.element.querySelectorAll(".column__cards"),t=this.element.querySelectorAll(".column__footer");e.forEach((e=>{e.addEventListener("mousedown",this.onMouseDown),e.addEventListener("click",this.onClickCardDelete)})),t.forEach((e=>e.addEventListener("click",this.onClickFooter))),window.addEventListener("beforeunload",(()=>{this.stateService.save(this.state)})),document.addEventListener("DOMContentLoaded",(()=>{const{cards:e}=this.stateService.load();e.length>0&&this.drawCards(e)}))}onMouseDown(e){e.target.classList.contains("column__card")&&(e.preventDefault(),document.documentElement.style.cursor="grabbing",this.dragEl=new a(e.target,e.clientX,e.clientY),this.dragEl.card=this.state.cards.find((e=>e.id===this.dragEl.elem.getAttribute("data-id"))),this.dragEl.index=this.state.cards.indexOf(this.dragEl.card),this.dragEl.bindToDOM(e.clientX,e.clientY),document.documentElement.addEventListener("mouseup",this.onMouseUp),document.documentElement.addEventListener("mousemove",this.onMouseMove))}onMouseMove(e){this.dragEl.move(e.clientX,e.clientY),this.renderGhost(e.target)}onMouseUp(){if(document.documentElement.style.cursor="auto","HTML"!==this.underDrag.tagName&&"BODY"!==this.underDrag.tagName){if(this.isGhostUnderDrag&&(this.underDrag.nextElementSibling?this.underDrag=this.underDrag.nextElementSibling:this.underDrag=this.underDrag.closest(".column").querySelector(".column__footer")),this.isColumnCardUnderDrag=this.underDrag.parentElement.classList.contains("column__cards"),this.isColumnFooterElemUnderDrag=this.underDrag.parentElement.classList.contains("column__footer"),this.isColumnFooterUnderDrag=this.underDrag.classList.contains("column__footer"),this.isGhostUnderDrag=this.underDrag.classList.contains("ghost"),this.dragEl.ghost.delete(),this.isColumnCardUnderDrag&&(this.changeOrderInState("column__cards",this.underDrag),this.underDrag.parentElement.insertBefore(this.dragEl.elem,this.underDrag),this.dragEl.ghost.delete()),this.isColumnFooterElemUnderDrag){this.dragEl.ghost.delete();const e=this.underDrag.parentElement.parentElement.querySelector(".column__cards");this.changeOrderInState("column__footer",e.children[e.children.length-1]),e.append(this.dragEl.elem)}if(this.isColumnFooterUnderDrag){this.dragEl.ghost.delete();const e=this.underDrag.parentElement.querySelector(".column__cards");this.changeOrderInState("column__footer",e.children[e.children.length-1]),e.append(this.dragEl.elem)}}this.clearElements(),document.documentElement.removeEventListener("mouseup",this.onMouseUp),document.documentElement.removeEventListener("mousemove",this.onMouseMove)}renderGhost(e){this.isColumn=!!e.closest(".column"),this.isColumn&&(this.underDrag=e,this.isColumnCardUnderDrag=this.underDrag.parentElement.classList.contains("column__cards"),this.isColumnFooterElemUnderDrag=this.underDrag.parentElement.classList.contains("column__footer"),this.isColumnFooterUnderDrag=this.underDrag.classList.contains("column__footer"),this.isGhostUnderDrag=this.underDrag.classList.contains("ghost"),this.isColumnCardUnderDrag&&this.underDrag.parentElement.insertBefore(this.dragEl.ghost.elem,this.underDrag),this.isColumnFooterElemUnderDrag&&this.underDrag.parentElement.parentElement.querySelector(".column__cards").append(this.dragEl.ghost.elem),this.isColumnFooterUnderDrag&&this.underDrag.parentElement.querySelector(".column__cards").append(this.dragEl.ghost.elem))}changeOrderInState(e,t){let s,n;t&&(s=this.state.cards.find((e=>e.id===t.getAttribute("data-id"))),n=this.state.cards.indexOf(s));const r=this.state.cards.splice(this.dragEl.index,1)[0];"column__cards"===e&&(n>this.dragEl.index?this.state.cards.splice(n-1,0,r):this.state.cards.splice(n,0,r)),"column__footer"===e&&(t?this.state.cards.splice(n+1,0,r):this.state.cards.unshift(r)),this.underDrag.classList.contains("column__footer")?this.dragEl.card.column=this.underDrag.parentElement.className:this.dragEl.card.column=this.underDrag.parentElement.parentElement.className}clearElements(){this.dragEl.clear(),this.dragEl=null,this.underDrag=null,this.isColumn=null,this.isColumnCardUnderDrag=null,this.isColumnFooterElemUnderDrag=null,this.isColumnFooterUnderDrag=null}onClickCardDelete(e){e.target.classList.contains("column__card-close")&&this.deleteCard(e.target)}deleteCard(e){const t=e.closest(".column__card"),s=t.getAttribute("data-id");this.state.cards=this.state.cards.filter((e=>e.id!==s)),t.remove()}onClickFooter(e){(e.target.classList.contains("column__add")||e.target.classList.contains("column__add-close"))&&this.changeFooter(e.target),e.target.classList.contains("column__save")&&this.onClickSave(e.target)}changeFooter(e){const t=e.closest(".column__footer");if(1===t.children.length)return e.remove(),void t.insertAdjacentHTML("beforeend",d.markupSaveBtn);t.children.length>1&&([...t.children].forEach((e=>e.remove())),t.insertAdjacentHTML("beforeend",d.markupAddBtn))}onClickSave(e){const t=e.closest(".column"),s=t.querySelector(".column__cards"),n=t.querySelector(".column__add-textarea").value,i=new o(n,t.className,r());this.state.cards.push(i),s.append(i.create()),this.changeFooter(e)}drawCards(e){e.forEach((e=>{const t=new o(e.text,e.column,r());this.state.cards.push(t),[...document.querySelectorAll(".column")].find((e=>e.className===t.column)).querySelector(".column__cards").append(t.create())}))}}const c=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("cards",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("cards"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new d(c).init()})();
//# sourceMappingURL=main.js.map